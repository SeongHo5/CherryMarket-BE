<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace = "com.cherrydev.cherrymarketbe.goods.repository.GoodsMapper">
    <resultMap id = "goodsRegistrationMap" type = "com.cherrydev.cherrymarketbe.goods.dto.GoodsRegistrationDto">
        <result property = "goodsId" column = "GOODS_ID"/>
        <result property = "makerId" column = "MAKR_ID"/>
        <result property = "categoryId" column = "CTGRY_ID"/>
        <result property = "goodsCode" column = "GOODS_CODE"/>
        <result property = "goodsName" column = "GOODS_NM"/>
        <result property = "description" column = "GOODS_DC"/>
        <result property = "discountId" column = "GOODS_DSCNT_ID"/>
        <result property = "price" column = "GOODS_PRICE"/>
        <result property = "retailPrice" column = "GOODS_SPLPC"/>
        <result property = "inventory" column = "GOODS_INVTRY"/>
        <result property = "storageType" column = "GOODS_CSTDY_TY"/>
        <result property = "capacity" column = "GOODS_CPCY"/>
        <result property = "expDate" column = "GOODS_EXPR_DE"/>
        <result property = "allergyInfo" column = "GOODS_ALLERGY_INFO"/>
        <result property = "originPlace" column = "GOODS_ORGPLCE"/>
        <result property = "salesStatus" column = "GOODS_SEL_STTUS"/>
        <result property = "createDate" column = "CREAT_DE"/>
        <result property = "updateDate" column = "UPDT_DE"/>
    </resultMap>

    <!-- Insert -->
    <insert id = "save" parameterType = "com.cherrydev.cherrymarketbe.goods.dto.GoodsRegistrationDto">
        INSERT INTO GOODS
            VALUE (NULL, #{makerId}, #{categoryId}, #{goodsCode}, #{goodsName}, #{description}, #{discountId}, #{price}, #{retailPrice}, #{inventory}, #{storageType}, #{capacity},
                   #{expDate}, #{allergyInfo}, #{originPlace}, #{salesStatus}, NOW(), NOW())
    </insert>

    <!-- Select -->
    <select id = "findAll" resultMap = "goodsRegistrationMap">
        SELECT *
        FROM GOODS
        WHERE GOODS_SEL_STTUS != 'DISCONTINUANCE'
        ORDER BY CREAT_DE DESC
    </select>

    <select id = "findBasicInfo" resultType = "com.cherrydev.cherrymarketbe.goods.dto.GoodsBasicInfoDto" parameterType = "long">
        SELECT G.GOODS_ID, G.GOODS_NM, G.GOODS_DC, G.GOODS_PRICE, D.DSCNT_RATE
        FROM GOODS G
                 LEFT JOIN DSCNT D ON G.GOODS_DSCNT_ID = D.DSCNT_ID
        WHERE G.GOODS_ID = #{goodsId}
    </select>

    <select id = "findByCategoryId" resultType = "com.cherrydev.cherrymarketbe.goods.dto.GoodsBasicInfoDto">
        SELECT G.GOODS_ID, G.GOODS_NM, G.GOODS_DC, G.GOODS_PRICE, D.DSCNT_RATE
        FROM GOODS G
                 LEFT JOIN DSCNT D ON G.GOODS_DSCNT_ID = D.DSCNT_ID
        WHERE (G.CTGRY_ID = #{categoryId}
            OR G.CTGRY_ID IN (SELECT C.CTGRY_ID
                              FROM CTGRY C
                              WHERE C.CTGRY_UPPER = #{categoryId}
                                AND C.CTGRY_UPPER IS NOT NULL))
          AND G.GOODS_SEL_STTUS != 'DISCONTINUANCE'
        ORDER BY G.CREAT_DE DESC
    </select>

    <select id = "findToCart" resultType = "com.cherrydev.cherrymarketbe.goods.dto.ToCartDto" parameterType = "long">
        SELECT G.GOODS_ID, G.GOODS_NM, G.GOODS_PRICE, G.GOODS_INVTRY, G.GOODS_CSTDY_TY, G.GOODS_SEL_STTUS, D.DSCNT_RATE
        FROM GOODS G
                 LEFT JOIN DSCNT D ON G.GOODS_DSCNT_ID = D.DSCNT_ID
        WHERE G.GOODS_ID = #{goodsId}
          AND G.GOODS_SEL_STTUS != 'DISCONTINUANCE'
        ORDER BY G.CREAT_DE DESC
    </select>

    <select id = "findDetailById" resultType = "com.cherrydev.cherrymarketbe.goods.dto.GoodsDetailDto" parameterType = "long">
        SELECT G.GOODS_ID,
               G.GOODS_CODE,
               G.GOODS_NM,
               G.GOODS_DC,
               G.GOODS_PRICE,
               G.GOODS_INVTRY,
               G.GOODS_CSTDY_TY,
               G.GOODS_CPCY,
               G.GOODS_EXPR_DE,
               G.GOODS_ALLERGY_INFO,
               G.GOODS_ORGPLCE,
               G.GOODS_SEL_STTUS,
               D.DSCNT_RATE,
               M.MAKR_NM
        FROM GOODS G
                 LEFT JOIN DSCNT D ON G.GOODS_DSCNT_ID = D.DSCNT_ID
                 LEFT JOIN MAKR M ON G.MAKR_ID = M.MAKR_ID
        WHERE G.GOODS_ID = #{goodsId}
          AND G.GOODS_SEL_STTUS != 'DISCONTINUANCE'
    </select>

    <select id = "findDetailByCode" resultType = "com.cherrydev.cherrymarketbe.goods.dto.GoodsDetailDto">
        SELECT G.GOODS_ID,
               G.GOODS_CODE,
               G.GOODS_NM,
               G.GOODS_DC,
               G.GOODS_PRICE,
               G.GOODS_INVTRY,
               G.GOODS_CSTDY_TY,
               G.GOODS_CPCY,
               G.GOODS_EXPR_DE,
               G.GOODS_ALLERGY_INFO,
               G.GOODS_ORGPLCE,
               G.GOODS_SEL_STTUS,
               D.DSCNT_RATE,
               M.MAKR_NM
        FROM GOODS G
                 LEFT JOIN DSCNT D ON G.GOODS_DSCNT_ID = D.DSCNT_ID
                 LEFT JOIN MAKR M ON G.MAKR_ID = M.MAKR_ID
        WHERE G.GOODS_CODE = #{goodsCode}
          AND G.GOODS_SEL_STTUS != 'DISCONTINUANCE'
    </select>

    <!-- Update -->
    <update id = "updateStatusWhenNewGoods" parameterType="com.cherrydev.cherrymarketbe.goods.dto.GoodsRegistrationDto">
        UPDATE GOODS SET GOODS_SEL_STTUS = #{salesStatus}
        WHERE GOODS_CODE = #{goodsCode}
    </update>


    <!-- Delete -->
    <delete id = "deleteById" parameterType = "Long">
        DELETE
        FROM GOODS
        WHERE GOODS_ID = #{goodsId};
    </delete>
</mapper>
